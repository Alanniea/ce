#!/bin/bash
set -e

# ==================================================
#               åŸºç¡€ä¿¡æ¯ (Basic Info)
# ==================================================
# Changelog:
# v1.1.1:
# - Fixed vnstat initialization for modern versions (e.g., vnstat > 2.7)
#   by checking for and using the `vnstat --add` command.
# - Improved system service detection (vnstat vs vnstatd).
# - Added a verification step to ensure the database is initialized.
# - Minor improvements to output messages.
VERSION="1.1.1"
REPO="Alanniea/ce"
SCRIPT_PATH="/root/install_limit.sh"
CONFIG_FILE="/etc/limit_config.conf"
# ç¡®ä¿é…ç½®ç›®å½•å­˜åœ¨ (Ensure config directory exists)
mkdir -p /etc

# é»˜è®¤é…ç½® (Default config)
DEFAULT_GB=20
DEFAULT_RATE="512kbit"

# ==================================================
#              è‡ªåŠ¨ä¿å­˜è‡ªèº« (Self-Save)
# ==================================================
# å¦‚æœå½“å‰è„šæœ¬ä¸æ˜¯åœ¨ç›®æ ‡è·¯å¾„ï¼Œå¹¶ä¸”ç›®æ ‡è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™ä¿å­˜è‡ªèº«
# (If the script isn't at the target path and the target path doesn't exist, save itself)
if [[ "$0" != "$SCRIPT_PATH" && ! -f "$SCRIPT_PATH" ]]; then
    echo "ğŸ’¾ æ­£åœ¨ä¿å­˜ install_limit.sh åˆ° $SCRIPT_PATH..."
    # ä½¿ç”¨ curl ä» GitHub ä¸‹è½½è„šæœ¬
    curl -fsSL "https://raw.githubusercontent.com/$REPO/main/install_limit.sh" -o "$SCRIPT_PATH"
    # èµ‹äºˆæ‰§è¡Œæƒé™
    chmod +x "$SCRIPT_PATH"
    echo "âœ… å·²ä¿å­˜ã€‚è¯·é€šè¿‡æ‰§è¡Œ $SCRIPT_PATH è¿è¡Œæ–°è„šæœ¬ã€‚"
    # é€€å‡ºå½“å‰è„šæœ¬ï¼Œè®©ç”¨æˆ·æ‰§è¡Œæ–°ä½ç½®çš„è„šæœ¬
    exit 0
fi

# ==================================================
#              è‡ªåŠ¨æ›´æ–°å‡½æ•° (Update Function)
# ==================================================
check_update() {
    echo "ğŸ“¡ æ­£åœ¨æ£€æŸ¥æ›´æ–°..."
    # ä»è¿œç¨‹ä»“åº“è·å–æœ€æ–°ç‰ˆæœ¬å·
    LATEST=$(curl -s "https://raw.githubusercontent.com/$REPO/main/install_limit.sh" | grep '^VERSION=' | head -n1 | cut -d'"' -f2)
    
    if [[ -n "$LATEST" && "$LATEST" != "$VERSION" ]]; then
        echo "ğŸ†• å‘ç°æ–°ç‰ˆæœ¬: $LATESTï¼Œå½“å‰ç‰ˆæœ¬: $VERSION"
        read -p "æ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ[Y/n] " choice
        # å¦‚æœç”¨æˆ·è¾“å…¥ Y/y æˆ–ç›´æ¥å›è½¦ï¼Œåˆ™æ‰§è¡Œæ›´æ–°
        if [[ "$choice" =~ ^[Yy]$ || -z "$choice" ]]; then
            curl -fsSL "https://raw.githubusercontent.com/$REPO/main/install_limit.sh" -o "$SCRIPT_PATH"
            chmod +x "$SCRIPT_PATH"
            echo "âœ… æ›´æ–°å®Œæˆï¼Œè¯·é‡æ–°æ‰§è¡Œ $SCRIPT_PATH ä»¥ä½¿ç”¨æ–°ç‰ˆæœ¬ã€‚"
            exit 0
        else
            echo "ğŸš« å·²å–æ¶ˆæ›´æ–°ã€‚"
        fi
    else
        echo "âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ($VERSION)ã€‚"
    fi
}

# ==================================================
#           æ”¯æŒ --update å‚æ•° (Handle --update)
# ==================================================
if [[ "$1" == "--update" ]]; then
    check_update
    exit 0
fi

# ==================================================
#             åˆå§‹åŒ–é…ç½® (Initialize Config)
# ==================================================
# å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºé»˜è®¤é…ç½®
if [ ! -f "$CONFIG_FILE" ]; then
    echo "LIMIT_GB=$DEFAULT_GB" > "$CONFIG_FILE"
    echo "LIMIT_RATE=$DEFAULT_RATE" >> "$CONFIG_FILE"
fi
# åŠ è½½é…ç½®
source "$CONFIG_FILE"

# ==================================================
#             æ­¥éª¤ 0: æ£€æµ‹ç³»ç»Ÿä¸ç½‘å¡
# ==================================================
echo "ğŸ› ï¸ [0/6] æ£€æµ‹ç³»ç»Ÿä¸ç½‘å¡..."
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS_NAME=$ID
    OS_VER=$VERSION_ID
else
    OS_NAME=$(uname -s)
    OS_VER=$(uname -r)
fi
echo "  - ç³»ç»Ÿ (OS): $OS_NAME $OS_VER"

# ä¼˜åŒ–çš„ç½‘å¡æ£€æµ‹æ–¹æ³•ï¼šé€šè¿‡è·¯ç”±è¡¨æ‰¾åˆ°é»˜è®¤å‡ºå£ç½‘å¡
IFACE=$(ip -4 route get 1.1.1.1 | awk '{print $5}' | head -n1)
if [ -z "$IFACE" ]; then
    echo "âš ï¸ æ— æ³•é€šè¿‡è·¯ç”±è¡¨è‡ªåŠ¨æ£€æµ‹åˆ°ä¸»ç½‘å¡ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•..."
    # å¤‡ç”¨æ–¹æ³•ï¼šæ’é™¤è™šæ‹Ÿå’Œç¯å›ç½‘å¡
    IFACE=$(ip -o link show | awk -F': ' '{print $2}' | grep -vE '^(lo|docker|br-|veth|tun|vmnet|virbr)' | head -n1)
fi

if [ -z "$IFACE" ]; then
    echo "âŒ é”™è¯¯ï¼šæœªæ£€æµ‹åˆ°æœ‰æ•ˆç½‘å¡ï¼Œè¯·æ‰‹åŠ¨åœ¨è„šæœ¬ä¸­è®¾ç½® IFACE å˜é‡ã€‚"
    exit 1
fi
echo "  - ä¸»ç½‘å¡ (Interface): $IFACE"

# ==================================================
#                 æ­¥éª¤ 1: å®‰è£…ä¾èµ–
# ==================================================
echo "ğŸ› ï¸ [1/6] å®‰è£…ä¾èµ–..."
if command -v apt >/dev/null; then
    apt update -y && apt install -y vnstat iproute2 curl jq speedtest-cli
elif command -v yum >/dev/null; then
    yum install -y epel-release && yum install -y vnstat iproute curl jq speedtest-cli
else
    echo "âš ï¸ æœªçŸ¥åŒ…ç®¡ç†å™¨ï¼Œè¯·æ‰‹åŠ¨å®‰è£… vnstat, iproute2, curl, jq, speedtest-cli"
fi

# ==================================================
#               æ­¥éª¤ 2: åˆå§‹åŒ– vnStat
# ==================================================
echo "ğŸ› ï¸ [2/6] åˆå§‹åŒ– vnStat..."
VNSTAT_ADD_CMD=""

# *** FIX START: ä¿®æ­£ vnstat åˆå§‹åŒ–é€»è¾‘ ***
# æ£€æŸ¥ `--add` (vnstat >= 2.7)ï¼Œè¿™æ˜¯æ–°ç‰ˆæœ¬çš„æ–¹å¼
if vnstat --help 2>&1 | grep -q -- '--add'; then
    VNSTAT_ADD_CMD="vnstat --add -i"
# æ£€æŸ¥ `--create` (æ—§ç‰ˆæœ¬)
elif vnstat --help 2>&1 | grep -q -- '--create'; then
    VNSTAT_ADD_CMD="vnstat --create -i"
# æ£€æŸ¥ `-u` (æ›´æ—§çš„ç‰ˆæœ¬)
elif vnstat --help 2>&1 | grep -q -- '-u'; then
    VNSTAT_ADD_CMD="vnstat -u -i"
fi

if [ -n "$VNSTAT_ADD_CMD" ]; then
    echo "  - æ­£åœ¨ä½¿ç”¨å‘½ä»¤å°†ç½‘å¡æ·»åŠ åˆ° vnStat: '$VNSTAT_ADD_CMD $IFACE'"
    # æ·»åŠ ç½‘å¡åˆ° vnstat æ•°æ®åº“ï¼Œ`|| true` ç¡®ä¿å³ä½¿å·²å­˜åœ¨ä¹Ÿä¸ä¼šæŠ¥é”™é€€å‡º
    $VNSTAT_ADD_CMD "$IFACE" || true
else
    echo "âš ï¸ è­¦å‘Š: æ— æ³•è‡ªåŠ¨æ‰¾åˆ°æ·»åŠ ç½‘å¡çš„ vnstat å‘½ä»¤ã€‚"
    echo "   è¯·ç¨åæ‰‹åŠ¨å°è¯• 'vnstat --add -i $IFACE'ã€‚"
fi

# ç¡®ä¿ vnstat æœåŠ¡å·²å¯åŠ¨å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯
# åœ¨æŸäº›ç³»ç»Ÿä¸Šï¼ŒæœåŠ¡åå¯èƒ½æ˜¯ vnstatd
if systemctl list-units --type=service | grep -q 'vnstatd.service'; then
    SERVICE_NAME="vnstatd"
else
    SERVICE_NAME="vnstat"
fi

echo "  - å¯ç”¨å¹¶é‡å¯æœåŠ¡: $SERVICE_NAME"
systemctl enable "$SERVICE_NAME"
systemctl restart "$SERVICE_NAME"
sleep 2

# éªŒè¯æ•°æ®åº“æ˜¯å¦ä¸ºç½‘å¡åˆ›å»ºæˆåŠŸ
if ! vnstat -i "$IFACE" >/dev/null 2>&1; then
    echo "âŒ é”™è¯¯: vnstat æ•°æ®åº“ä¼¼ä¹ä»æœªä¸ºç½‘å¡ '$IFACE' åˆå§‹åŒ–ã€‚"
    echo "   å®‰è£…å°†ç»§ç»­ï¼Œä½†è¯·åŠ¡å¿…æ‰‹åŠ¨è§£å†³æ­¤é—®é¢˜ã€‚"
    echo "   è¯·å°è¯•æ‰§è¡Œ 'vnstat --add -i $IFACE' å¹¶æ£€æŸ¥ 'systemctl status $SERVICE_NAME' çš„çŠ¶æ€ã€‚"
else
    echo "  - vnStat for interface '$IFACE' initialized successfully."
fi
# *** FIX END ***


# ==================================================
#               æ­¥éª¤ 3: ç”Ÿæˆé™é€Ÿè„šæœ¬
# ==================================================
echo "ğŸ“ [3/6] ç”Ÿæˆé™é€Ÿè„šæœ¬ (limit_bandwidth.sh)..."
cat > /root/limit_bandwidth.sh <<EOL
#!/bin/bash
# è¯¥è„šæœ¬ç”± install_limit.sh è‡ªåŠ¨ç”Ÿæˆ

IFACE="$IFACE"
CONFIG_FILE=/etc/limit_config.conf
source "\$CONFIG_FILE"

# è·å–ä»Šå¤©çš„æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD
TODAY=\$(date '+%Y-%m-%d')

# ä½¿ç”¨ vnstat --json è·å–æ•°æ®ï¼Œå¹¶é€šè¿‡ jq è§£æï¼Œæ¯”ä¼ ç»Ÿ grep/awk æ›´ç¨³å®š
# .interfaces[0] å‡è®¾åªæœ‰ä¸€ä¸ªè¢«ç›‘æ§çš„ç½‘å¡
# select(.id == \$d) æ‰¾åˆ°ä»Šå¤©çš„æ•°æ®
# .rx è·å–ä¸‹è¡Œæµé‡ï¼ˆå•ä½ KiBï¼‰ï¼Œå¦‚æœå½“å¤©æ²¡æœ‰æ•°æ®åˆ™è¿”å› 0
RX_KIB=\$(vnstat --json d -i "\$IFACE" | jq --arg d "\$TODAY" '.interfaces[0].traffic.days[] | select(.id == \$d) | .rx // 0')

# ä½¿ç”¨ awk å°† KiB è½¬æ¢ä¸º GiB
USAGE_GB=\$(awk "BEGIN{printf \"%.2f\", \$RX_KIB/1024/1024}")
# è®¡ç®—å·²ç”¨ç™¾åˆ†æ¯”
PCT=\$(awk "BEGIN{printf \"%d\", (\$USAGE_GB/\$LIMIT_GB)*100}")

# ä½¿ç”¨ awk è¿›è¡Œæµ®ç‚¹æ•°æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°é™é€Ÿé˜ˆå€¼
if awk "BEGIN{exit !(\$USAGE_GB >= \$LIMIT_GB)}"; then
    echo "[é™é€Ÿ] \${USAGE_GB}GiB (\${PCT}%) â†’ è¾¾åˆ°é˜ˆå€¼ï¼Œå¼€å§‹é™é€Ÿè‡³ \$LIMIT_RATE"
    # æ¸…é™¤æ—§çš„è§„åˆ™ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç„¶åæ·»åŠ æ–°çš„ TBF é™é€Ÿè§„åˆ™
    tc qdisc del dev "\$IFACE" root 2>/dev/null || true
    tc qdisc add dev "\$IFACE" root tbf rate "\$LIMIT_RATE" burst 32kbit latency 400ms
else
    echo "[æ­£å¸¸] \${USAGE_GB}GiB (\${PCT}%) â†’ æœªè¾¾åˆ°é˜ˆå€¼ï¼Œè§£é™¤é™é€Ÿ"
    # æ¸…é™¤æ‰€æœ‰é™é€Ÿè§„åˆ™
    tc qdisc del dev "\$IFACE" root 2>/dev/null || true
fi

# è®°å½•æœ€åè¿è¡Œæ—¶é—´
date '+%Y-%m-%d %H:%M:%S' > /var/log/limit_last_run
EOL
chmod +x /root/limit_bandwidth.sh

# ==================================================
#            æ­¥éª¤ 4: ç”Ÿæˆè§£é™¤é™é€Ÿè„šæœ¬
# ==================================================
echo "ğŸ“ [4/6] ç”Ÿæˆè§£é™¤é™é€Ÿè„šæœ¬ (clear_limit.sh)..."
cat > /root/clear_limit.sh <<EOL
#!/bin/bash
IFACE="$IFACE"
echo "æ­£åœ¨æ¸…é™¤ç½‘å¡ \$IFACE ä¸Šçš„æ‰€æœ‰ tc é™é€Ÿè§„åˆ™..."
tc qdisc del dev "\$IFACE" root 2>/dev/null || true
echo "âœ… æ¸…é™¤å®Œæˆã€‚"
EOL
chmod +x /root/clear_limit.sh

# ==================================================
#               æ­¥éª¤ 5: å†™å…¥ cron ä»»åŠ¡
# ==================================================
echo "ğŸ“… [5/6] è®¾ç½® cron å®šæ—¶ä»»åŠ¡..."
# å…ˆå¤‡ä»½å¹¶æ¸…é™¤æ—§çš„è„šæœ¬ä»»åŠ¡ï¼Œé˜²æ­¢é‡å¤
(crontab -l 2>/dev/null | grep -vE 'limit_bandwidth.sh|clear_limit.sh|speed_test.sh') > /tmp/crontab.bak || true
# æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡é™é€Ÿæ£€æŸ¥
echo "0 * * * * /root/limit_bandwidth.sh >> /var/log/limit.log 2>&1" >> /tmp/crontab.bak
# æ¯å¤© 0 ç‚¹ 0 åˆ†ï¼Œæ¸…é™¤é™é€Ÿï¼Œå¹¶æ›´æ–° vnstat æ•°æ®
echo "0 0 * * * /root/clear_limit.sh && vnstat -i $IFACE --update" >> /tmp/crontab.bak
crontab /tmp/crontab.bak
rm -f /tmp/crontab.bak

# ==================================================
#               é™„åŠ åŠŸèƒ½: æµ‹é€Ÿè„šæœ¬
# ==================================================
echo "ğŸ“¡ [é™„åŠ ] ç”Ÿæˆæµ‹é€Ÿè„šæœ¬ (speed_test.sh)..."
cat > /root/speed_test.sh <<'EOF'
#!/bin/bash
echo "ğŸŒ æ­£åœ¨ä½¿ç”¨ speedtest-cli è¿›è¡Œæµ‹é€Ÿ..."
speedtest --simple
echo "ğŸ”„ æµ‹é€Ÿå®Œæˆï¼Œæ›´æ–° vnStat æ•°æ®åº“..."
vnstat --update
EOF
chmod +x /root/speed_test.sh

# ==================================================
#               æ­¥éª¤ 6: ç”Ÿæˆäº¤äº’å‘½ä»¤ ce
# ==================================================
echo "ğŸ§© [6/6] ç”Ÿæˆäº¤äº’å¼æ§åˆ¶å°å‘½ä»¤ (ce)..."
cat > /usr/local/bin/ce <<EOF
#!/bin/bash
# è¯¥è„šæœ¬ç”± install_limit.sh è‡ªåŠ¨ç”Ÿæˆ

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
CYAN='\033[1;36m'; RESET='\033[0m'

# ä¼˜å…ˆå¤„ç† --update å‚æ•°
if [[ "\$1" == "--update" ]]; then
    exec /root/install_limit.sh --update
fi

CONFIG_FILE=/etc/limit_config.conf
source "\$CONFIG_FILE"
VERSION=\$(grep '^VERSION=' /root/install_limit.sh | cut -d'"' -f2)
IFACE=\$(ip -4 route get 1.1.1.1 | awk '{print \$5}' | head -n1)
# å¤‡ç”¨ç½‘å¡æ£€æµ‹
[ -z "\$IFACE" ] && IFACE=\$(ip -o link show | awk -F': ' '{print \$2}' | grep -vE '^(lo|docker|br-|veth|tun|vmnet|virbr)' | head -n1)

show_menu() {
    clear
    
    # æ•°æ®è·å–
    TODAY=\$(date '+%Y-%m-%d')
    OS_INFO=\$(grep '^PRETTY_NAME=' /etc/os-release 2>/dev/null | cut -d'"' -f2 || echo "N/A")
    IP4=\$(curl -s4 ifconfig.me || echo "æœªçŸ¥")
    LAST_RUN=\$(cat /var/log/limit_last_run 2>/dev/null || echo "N/A")

    # ä½¿ç”¨ jq è§£æ JSON è·å–æµé‡æ•°æ®
    JSON_DATA=\$(vnstat --json d -i "\$IFACE" 2>/dev/null)
    if [[ -n "\$JSON_DATA" ]]; then
        TODAY_DATA=\$(echo "\$JSON_DATA" | jq --arg d "\$TODAY" '.interfaces[0].traffic.days[] | select(.id == \$d)')
        if [[ -z "\$TODAY_DATA" ]]; then
            RX_GB=0.00; TX_GB=0.00;
        else
            RX_KIB=\$(echo "\$TODAY_DATA" | jq '.rx'); TX_KIB=\$(echo "\$TODAY_DATA" | jq '.tx');
            RX_GB=\$(awk "BEGIN{printf \"%.2f\", \$RX_KIB/1024/1024}"); TX_GB=\$(awk "BEGIN{printf \"%.2f\", \$TX_KIB/1024/1024}");
        fi
        PCT=\$(awk "BEGIN{printf \"%.1f\", \$RX_GB/\$LIMIT_GB*100}")
    else
        RX_GB="N/A"; TX_GB="N/A"; PCT="N/A";
    fi

    # è·å–å½“å‰é™é€ŸçŠ¶æ€
    TC_OUT=\$(tc qdisc show dev "\$IFACE" 2>/dev/null)
    if echo "\$TC_OUT" | grep -q "tbf"; then
        LIMIT_STATE="\${GREEN}âœ… æ­£åœ¨é™é€Ÿ\${RESET}"; CUR_RATE=\$(echo "\$TC_OUT" | grep -oP 'rate \K\S+');
    else
        LIMIT_STATE="\${YELLOW}ğŸ†— æœªé™é€Ÿ\${RESET}"; CUR_RATE="-";
    fi

    # ç»˜åˆ¶èœå•
    echo -e "\${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘             ğŸš¦ æµé‡é™é€Ÿç®¡ç†æ§åˆ¶å° (ce) v\${VERSION} â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\${RESET}"
    echo -e "\${YELLOW}ğŸ“… æ—¥æœŸ: \${TODAY}   ğŸ–¥ï¸ ç³»ç»Ÿ: \${OS_INFO}\${RESET}"
    echo -e "\${YELLOW}ğŸŒ ç½‘å¡: \${IFACE}   ğŸŒ å…¬ç½‘ IP: \${IP4}\${RESET}"
    echo -e "--------------------------------------------------------------"
    echo -e "\${GREEN}ğŸ“Š ä»Šæ—¥æµé‡: ä¸Šè¡Œ \${TX_GB} GiB / ä¸‹è¡Œ \${RX_GB} GiB\${RESET}"
    echo -e "\${GREEN}ğŸ“ˆ å·²ç”¨é¢åº¦: \${RX_GB} GiB / \${LIMIT_GB} GiB (\${PCT}%)\${RESET}"
    echo -e "\${GREEN}ğŸš¦ å½“å‰çŠ¶æ€: \${LIMIT_STATE} (é€Ÿç‡: \${CUR_RATE})\${RESET}"
    echo -e "\${GREEN}ğŸ•’ ä¸Šæ¬¡æ£€æµ‹: \${LAST_RUN}\${RESET}"
    echo -e "--------------------------------------------------------------"

    # æ›´æ–°æç¤º
    LATEST=\$(curl -s "https://raw.githubusercontent.com/$REPO/main/install_limit.sh" | grep '^VERSION=' | head -n1 | cut -d'"' -f2)
    if [[ -n "\$LATEST" && "\$LATEST" != "\$VERSION" ]]; then
        echo -e "\${RED}âš ï¸  æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬(\$LATEST)ï¼Œå»ºè®®è¿è¡Œ 'ce --update' æ›´æ–°ã€‚\${RESET}"
        echo -e "--------------------------------------------------------------"
    fi

    echo -e "${GREEN}1.${RESET} ç«‹å³æ£€æŸ¥å¹¶åº”ç”¨è§„åˆ™"
    echo -e "${GREEN}2.${RESET} æ‰‹åŠ¨è§£é™¤æ‰€æœ‰é™é€Ÿ"
    echo -e "${GREEN}3.${RESET} æŸ¥çœ‹ tc é™é€ŸçŠ¶æ€"
    echo -e "${GREEN}4.${RESET} æŸ¥çœ‹ vnStat æ¯æ—¥æµé‡"
    echo -e "${GREEN}5.${RESET} ${RED}å¸è½½é™é€Ÿè„šæœ¬å’Œä»»åŠ¡${RESET}"
    echo -e "${GREEN}6.${RESET} ä¿®æ”¹é™é€Ÿé…ç½®"
    echo -e "${GREEN}7.${RESET} é€€å‡º"
    echo -e "${GREEN}8.${RESET} æ£€æŸ¥è„šæœ¬æ›´æ–°"
    echo -e "${GREEN}9.${RESET} ç½‘ç»œæµ‹é€Ÿ (speedtest)"
    echo
}

while true; do
    show_menu
    read -p "ğŸ‘‰ è¯·é€‰æ‹©æ“ä½œ [1-9]: " opt
    echo

    case \$opt in
        1) /root/limit_bandwidth.sh;;
        2) /root/clear_limit.sh;;
        3) tc qdisc show dev "\$IFACE" || echo "å½“å‰æ— æ´»åŠ¨çš„ tc è§„åˆ™ã€‚";;
        4) vnstat -d -i "\$IFACE";;
        5)
            echo -e "\${RED}è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ç›¸å…³è„šæœ¬å’Œ cron ä»»åŠ¡ã€‚\${RESET}"
            read -p "ç¡®å®šè¦å¸è½½å—ï¼Ÿ[y/N] " confirm
            if [[ "\$confirm" =~ ^[Yy]$ ]]; then
                echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤ cron ä»»åŠ¡...";
                (crontab -l 2>/dev/null | grep -vE 'limit_bandwidth.sh|clear_limit.sh|speed_test.sh') | crontab -
                echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤è„šæœ¬æ–‡ä»¶...";
                rm -f /root/limit_bandwidth.sh /root/clear_limit.sh /root/speed_test.sh /usr/local/bin/ce /etc/limit_config.conf
                echo "âœ… å¸è½½å®Œæˆã€‚"; exit 0;
            else
                echo "ğŸš« å·²å–æ¶ˆå¸è½½ã€‚";
            fi;;
        6)
            echo "âš™ï¸ å½“å‰é…ç½®:"
            echo "  - æµé‡é™é¢ (LIMIT_GB): \$LIMIT_GB"
            echo "  - é™é€Ÿé€Ÿç‡ (LIMIT_RATE): \$LIMIT_RATE"
            read -p "è¯·è¾“å…¥æ–°çš„æµé‡é™é¢ (GiB) [å›è½¦è·³è¿‡: \$LIMIT_GB]: " new_gb
            read -p "è¯·è¾“å…¥æ–°çš„é™é€Ÿé€Ÿç‡ (å¦‚ 512kbit, 1mbit) [å›è½¦è·³è¿‡: \$LIMIT_RATE]: " new_rate
            if [[ -n "\$new_gb" ]]; then sed -i "s/LIMIT_GB=.*/LIMIT_GB=\$new_gb/" "\$CONFIG_FILE"; echo "âœ… æµé‡é™é¢å·²æ›´æ–°ä¸º \$new_gb GiBã€‚"; fi
            if [[ -n "\$new_rate" ]]; then sed -i "s/LIMIT_RATE=.*/LIMIT_RATE=\$new_rate/" "\$CONFIG_FILE"; echo "âœ… é™é€Ÿé€Ÿç‡å·²æ›´æ–°ä¸º \$new_rateã€‚"; fi
            source "\$CONFIG_FILE";;
        7) echo "ğŸ‘‹ å‘Šè¾ï¼"; exit 0;;
        8) /root/install_limit.sh --update;;
        9) /root/speed_test.sh;;
        *) echo -e "\${RED}âŒ æ— æ•ˆè¾“å…¥ï¼Œè¯·è¾“å…¥ 1-9 ä¹‹é—´çš„æ•°å­—ã€‚\${RESET}";;
    esac
    echo; read -p "æŒ‰ [Enter] é”®è¿”å›ä¸»èœå•...";
done
EOF
chmod +x /usr/local/bin/ce

echo -e "\nğŸ‰ å…¨éƒ¨å®Œæˆï¼"
echo "æ‚¨ç°åœ¨å¯ä»¥é€šè¿‡æ‰§è¡Œ \`${GREEN}ce${RESET}\` å‘½ä»¤æ¥ç®¡ç†æµé‡é™é€Ÿã€‚"
echo "ä¸»è¦è„šæœ¬å’Œæ—¥å¿—ï¼š"
echo "  - æ§åˆ¶å°: /usr/local/bin/ce"
echo "  - é…ç½®æ–‡ä»¶: $CONFIG_FILE"
echo "  - é™é€Ÿè„šæœ¬: /root/limit_bandwidth.sh"
echo "  - å®šæ—¶ä»»åŠ¡æ—¥å¿—: /var/log/limit.log"



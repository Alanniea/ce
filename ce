#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[1;36m'
RESET='\033[0m'

VERSION="1.0.0"
CONFIG_FILE=/etc/limit_config.conf
source $CONFIG_FILE
IFACE=$(ip -o link show | awk -F': ' '{print $2}' | grep -vE '^(lo|docker|br-|veth|tun|vmnet|virbr)' | head -n 1)

get_usage_info() {
  RAW=$(vnstat --oneline -i "$IFACE" 2>/dev/null | cut -d\; -f11 | sed 's/ GiB//')
  USAGE=$(printf "%.1f" "$RAW")
  USAGE_PERCENT=$(awk -v u="$RAW" -v l="$LIMIT_GB" 'BEGIN { printf "%.1f", (u / l) * 100 }')
  echo "$USAGE" "$USAGE_PERCENT"
}

get_today_traffic() {
  vnstat -i "$IFACE" --json | jq -r '.interfaces[0].traffic.day[-1] | "\(.rx/1024/1024) \(.tx/1024/1024)"' 2>/dev/null || echo "0 0"
}

is_limited() {
  tc qdisc show dev "$IFACE" | grep -q "tbf" && echo "âœ… æ­£åœ¨é™é€Ÿ" || echo "ğŸ†— æœªé™é€Ÿ"
}

get_current_limit_rate() {
  tc qdisc show dev "$IFACE" | grep -oE 'rate [0-9]+[kmg]bit' || echo "-"
}

get_public_ip() {
  curl -s https://ipinfo.io/ip || echo "æœªçŸ¥"
}

get_last_check_time() {
  [ -f /var/log/limit_check.log ] && tail -n1 /var/log/limit_check.log || echo "æ— è®°å½•"
}

while true; do
  clear
  read USAGE USAGE_PERCENT < <(get_usage_info)
  read RX TX < <(get_today_traffic)
  RX=$(printf "%.1f" "$RX")
  TX=$(printf "%.1f" "$TX")
  LIMIT_STATUS=$(is_limited)
  RATE=$(get_current_limit_rate)
  PUBIP=$(get_public_ip)
  LASTCHECK=$(get_last_check_time)
  OS_NAME=$(source /etc/os-release && echo "$ID $VERSION_ID")
  TODAY=$(date +"%Y-%m-%d")

  echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo -e "â•‘        ğŸš¦ æµé‡é™é€Ÿç®¡ç†æ§åˆ¶å°ï¼ˆceï¼‰v$VERSION           â•‘"
  echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
  echo -e "ğŸ“… å½“å‰æ—¥æœŸï¼š$TODAY"
  echo -e "ğŸ–¥ ç³»ç»Ÿç‰ˆæœ¬ï¼š$OS_NAME"
  echo -e "ğŸŒ ä¸»ç”¨ç½‘å¡ï¼š$IFACE"
  echo -e "ğŸŒ å…¬ç½‘ IPï¼š$PUBIP"
  echo -e "ğŸ“Š ä»Šæ—¥æµé‡ï¼šä¸Šè¡Œ ${TX} GiB / ä¸‹è¡Œ ${RX} GiB"
  echo -e "ğŸ“ˆ æµé‡ä½¿ç”¨ï¼š${USAGE} GiB / ${LIMIT_GB} GiBï¼ˆ${USAGE_PERCENT}%ï¼‰"
  echo -e "ğŸš¦ é™é€ŸçŠ¶æ€ï¼š$LIMIT_STATUS"
  echo -e "ğŸš€ å½“å‰é€Ÿç‡ï¼š$RATE"
  echo -e "ğŸ•’ ä¸Šæ¬¡æ£€æµ‹ï¼š$LASTCHECK"
  echo ""
  echo -e "${GREEN}1.${RESET} æ£€æŸ¥æ˜¯å¦åº”é™é€Ÿ"
  echo -e "${GREEN}2.${RESET} æ‰‹åŠ¨è§£é™¤é™é€Ÿ"
  echo -e "${GREEN}3.${RESET} æŸ¥çœ‹é™é€ŸçŠ¶æ€"
  echo -e "${GREEN}4.${RESET} æŸ¥çœ‹æ¯æ—¥æµé‡"
  echo -e "${GREEN}5.${RESET} åˆ é™¤é™é€Ÿè„šæœ¬"
  echo -e "${GREEN}6.${RESET} ä¿®æ”¹é™é€Ÿé…ç½®"
  echo -e "${GREEN}7.${RESET} é€€å‡º"
  echo -e "${GREEN}8.${RESET} æ£€æŸ¥ install_limit.sh æ›´æ–°"
  echo ""
  read -p "ğŸ‘‰ è¯·é€‰æ‹©æ“ä½œ [1-8]: " opt
  case "$opt" in
    1) echo "[$(date +"%Y-%m-%d %H:%M:%S")] æ‰§è¡Œé™é€Ÿæ£€æµ‹" >> /var/log/limit_check.log; bash /root/limit_bandwidth.sh ;;
    2) bash /root/clear_limit.sh ;;
    3) tc -s qdisc ls dev "$IFACE" ;;
    4) vnstat -d ;;
    5)
      rm -f /root/install_limit.sh /root/limit_bandwidth.sh /root/clear_limit.sh
      rm -f /usr/local/bin/ce
      echo -e "${YELLOW}å·²åˆ é™¤æ‰€æœ‰é™é€Ÿç›¸å…³è„šæœ¬å’Œæ§åˆ¶å‘½ä»¤${RESET}"
      break
      ;;
    6)
      echo -e "\nå½“å‰é™åˆ¶ï¼š${YELLOW}${LIMIT_GB} GiB${RESET}ï¼Œé™é€Ÿï¼š${YELLOW}${LIMIT_RATE}${RESET}"
      read -p "ğŸ”§ æ–°çš„æ¯æ—¥æµé‡é™åˆ¶ï¼ˆGiBï¼‰: " new_gb
      read -p "ğŸš€ æ–°çš„é™é€Ÿå€¼ï¼ˆå¦‚ 512kbitã€1mbitï¼‰: " new_rate
      if [[ "$new_gb" =~ ^[0-9]+$ ]] && [[ "$new_rate" =~ ^[0-9]+(kbit|mbit)$ ]]; then
        echo "LIMIT_GB=$new_gb" > $CONFIG_FILE
        echo "LIMIT_RATE=$new_rate" >> $CONFIG_FILE
        echo -e "${GREEN}âœ… é…ç½®å·²æ›´æ–°${RESET}"
      else
        echo -e "${RED}âŒ è¾“å…¥æ— æ•ˆ${RESET}"
      fi ;;
    7) break ;;
    8) bash /root/install_limit.sh --update ;;
    *) echo -e "${RED}âŒ æ— æ•ˆé€‰é¡¹${RESET}" ;;
  esac
  read -p "â æŒ‰å›è½¦ç»§ç»­..." dummy
done
